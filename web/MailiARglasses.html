<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="gbk">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR烹饪助手</title>
    
    <!-- Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Three.js Libraries from CDN -->
    <script async src="https://unpkg.com/es-module-shims@1.10.0/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.165.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.165.0/examples/jsm/"
        }
    }
    </script>

    <style>
        /* 毛玻璃背景效果 */
        .glass-effect {
            backdrop-filter: blur(20px) saturate(180%);
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-card {
            backdrop-filter: blur(15px) saturate(150%);
            background: rgba(55, 65, 81, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .glass-nav {
            backdrop-filter: blur(25px) saturate(200%);
            background: rgba(17, 24, 39, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* 渐变背景 */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-bg-dark {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { 
            background: rgba(30, 30, 30, 0.3);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }

        /* 高级开关样式 */
        .switch input { display: none; }
        .switch .slider {
            width: 52px; height: 32px;
            background: linear-gradient(135deg, #4A5568 0%, #2D3748 100%);
            border-radius: 16px; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; cursor: pointer;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .switch .slider:before {
            content: ""; position: absolute; height: 24px; width: 24px;
            left: 4px; bottom: 4px; background: #CBD5E0;
            border-radius: 50%; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .switch input:checked + .slider { 
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        .switch input:checked + .slider:before { 
            transform: translateX(20px); 
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        /* 高级动画效果 */
        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: calc(200px + 100%) 0;
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        .slide-in-left {
            animation: slideInLeft 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        .pulse-hover:hover {
            animation: pulse 1s infinite;
        }
        
        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            background-size: 200px 100%;
            animation: shimmer 2s infinite;
        }

        /* 聊天消息样式增强 */
        .chat-message {
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(20px);
        }
        
        .chat-message.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .chat-message img {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
        }
        
        .chat-message img:hover {
            transform: scale(1.08) rotate(1deg);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            border-radius: 16px;
        }

        /* 按钮增强效果 */
        .btn-enhanced {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn-enhanced:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-enhanced:hover:before {
            left: 100%;
        }
        
        .btn-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .btn-enhanced:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* 卡片悬停效果 */
        .card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        
        .card-hover:hover .card-glow {
            opacity: 1;
        }
        
        .card-glow {
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: inherit;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.4s ease;
            filter: blur(8px);
        }

        /* 页面过渡效果 */
        main { 
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .page-hidden { 
            display: none !important; 
        }
        
        .page-enter {
            opacity: 0;
            transform: translateX(30px);
        }
        
        .page-enter-active {
            opacity: 1;
            transform: translateX(0);
        }

        /* 模态框增强效果 */
        .modal-overlay {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        
        .modal-hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .modal-visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        .modal-content {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(0.9) translateY(20px);
            opacity: 0;
        }
        
        .modal-visible .modal-content {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
        
        /* 导航栏增强 */
        .nav-btn {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .nav-btn:hover {
            transform: scale(1.1);
        }
        
        .nav-btn.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(147, 51, 234, 0.2));
        }
        
        .nav-btn.active:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #3B82F6, #9333EA);
            border-radius: inherit;
            z-index: -1;
            opacity: 0.1;
        }

        /* 加载动画增强 */
        .loading-enhanced {
            position: relative;
        }
        
        .loading-enhanced:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 1.5s infinite;
        }
        
        /* 容器样式 */
        .chat-container, .meeting-container { 
            width: 100%; 
            box-sizing: border-box;
        }
        
        /* 中国膳食宝塔样式 - 三角形进度条版本 */
        .nutrition-pyramid {
            position: relative;
            width: 100%;
            height: 300px;
            margin: 20px auto;
        }
        
        .pyramid-layer {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            height: 50px;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .pyramid-layer:hover {
            transform: translateX(-50%) scale(1.02);
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
        }
        
        .pyramid-layer-1 {
            top: 20px;
            width: 60%;
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .pyramid-layer-2 {
            top: 80px;
            width: 70%;
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .pyramid-layer-3 {
            top: 140px;
            width: 80%;
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .pyramid-layer-4 {
            top: 200px;
            width: 90%;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .pyramid-layer-5 {
            top: 260px;
            width: 100%;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }
        
        .layer-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            border-radius: inherit;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }
        
        /* 超出限制时的动画效果 */
        .layer-progress.overflow {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.4));
            animation: overflow-pulse 2s infinite;
        }
        
        .pyramid-layer.overflow {
            animation: shake 0.5s ease-in-out;
        }
        
        .pyramid-layer.overflow::after {
            content: '?';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: #fbbf24;
            font-weight: bold;
            z-index: 3;
            animation: warning-bounce 1s infinite;
        }
        
        @keyframes overflow-pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translate(-50%, 0); }
            25% { transform: translate(calc(-50% - 2px), 0); }
            75% { transform: translate(calc(-50% + 2px), 0); }
        }
        
        @keyframes warning-bounce {
            0%, 100% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-50%) scale(1.2); }
        }
        
        .layer-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            height: 100%;
            padding: 0 16px;
            z-index: 2;
            position: relative;
        }
        
        .layer-name {
            font-weight: 600;
            color: white;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .layer-value {
            font-weight: 700;
            color: white;
            font-size: 12px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        /* 食品项目样式 */
        .food-item {
            background: rgba(55, 65, 81, 0.8);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .food-item:hover {
            background: rgba(75, 85, 99, 0.8);
            border-color: rgba(96, 165, 250, 0.5);
            transform: translateY(-2px);
        }
        
        .food-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .food-item-name {
            font-weight: 600;
            color: white;
            font-size: 14px;
        }
        
        .food-item-time {
            font-size: 12px;
            color: #9ca3af;
        }
        
        .food-item-confidence {
            font-size: 12px;
            color: #60a5fa;
            font-weight: 500;
        }
        
        .food-item-calories {
            font-size: 12px;
            color: #fbbf24;
            font-weight: 500;
        }
    </style>
</head>
<body class="gradient-bg-dark font-sans antialiased overflow-x-hidden">

    <!-- Main App Container - Now responsive for larger screens -->
    <div id="app-container" class="max-w-md lg:max-w-6xl mx-auto glass-effect min-h-screen flex flex-col shadow-2xl overflow-x-hidden relative">
        <!-- 背景装饰元素 -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="absolute -top-40 -right-40 w-80 h-80 bg-gradient-to-br from-blue-400/20 to-purple-600/20 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-gradient-to-tr from-purple-400/20 to-pink-600/20 rounded-full blur-3xl"></div>
        </div>
        
        <div class="flex-grow pb-20 lg:pb-0"> <!-- Remove padding on desktop, nav bar is on the side -->

            <!-- On desktop, navigation is a sidebar -->
            <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto h-20 glass-nav border-t border-white/10 flex justify-around items-center z-20
                        lg:mx-0 lg:left-0 lg:top-0 lg:max-w-none lg:w-20 lg:h-screen lg:flex-col lg:justify-start lg:border-t-0 lg:border-r lg:border-white/10">
                <div class="hidden lg:block text-blue-400 p-4 my-4">
                     <img src="maili.svg" class="h-8 w-8" alt="Maili Logo">
                </div>
                <button data-page="home-page" class="nav-btn flex flex-col items-center justify-center text-blue-400 transition-colors w-full h-full lg:w-full lg:h-20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                    <span class="text-xs mt-1">首页</span>
                </button>
                <button data-page="recipes-page" class="nav-btn flex flex-col items-center justify-center text-gray-400 hover:text-gray-200 transition-colors w-full h-full lg:w-full lg:h-20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0114.5 16c1.255 0 2.443-.29 3.5-.804v-10A7.968 7.968 0 0014.5 4z" /></svg>
                    <span class="text-xs mt-1">菜谱</span>
                </button>
                <button data-page="device-page" class="nav-btn flex flex-col items-center justify-center text-gray-400 hover:text-gray-200 transition-colors w-full h-full lg:w-full lg:h-20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 2a1 1 0 00-1 1v1H5a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H9V3a1 1 0 00-1-1H7zM5 8h10v8H5V8zm2 2a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                <span class="text-xs mt-1">设备</span>
            </button>
            <button data-page="meeting-page" class="nav-btn flex flex-col items-center justify-center text-gray-400 hover:text-gray-200 transition-colors w-full h-full lg:w-full lg:h-20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    <span class="text-xs mt-1">会议</span>
                </button>
                <button data-page="food-page" class="nav-btn flex flex-col items-center justify-center text-gray-400 hover:text-gray-200 transition-colors w-full h-full lg:w-full lg:h-20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16l3-3m-3 3l-3-3" /></svg>
                    <span class="text-xs mt-1">食品</span>
                </button>
                <button data-page="media-page" class="nav-btn flex flex-col items-center justify-center text-gray-400 hover:text-gray-200 transition-colors w-full h-full lg:w-full lg:h-20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    <span class="text-xs mt-1">媒体</span>
                </button>
                <button data-page="chat-page" class="nav-btn flex flex-col items-center justify-center text-gray-400 hover:text-gray-200 transition-colors w-full h-full lg:w-full lg:h-20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.702A9 9 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                    <span class="text-xs mt-1">麦粒</span>
                </button>
        </nav>



            <div class="lg:pl-20"> <!-- Offset content for the desktop sidebar -->
                <!-- ================================================== -->
                <!-- ============== HOME PAGE ========================= -->
                <!-- ================================================== -->
                <main id="home-page" class="p-4 lg:p-8 space-y-6">
                    <!-- Content is now rendered by JS -->
                </main>

                <!-- ================================================== -->
                <!-- ============== RECIPES PAGE ====================== -->
                <!-- ================================================== -->
                <main id="recipes-page" class="p-4 lg:p-8 space-y-6 page-hidden">
                    <!-- Content is now rendered by JS -->
                </main>

                <!-- ================================================== -->
                <!-- ============ RECIPE DETAIL PAGE ================== -->
                <!-- ================================================== -->
                <main id="recipe-detail-page" class="page-hidden">
                    <!-- Content is now rendered by JS -->
                </main>

                <!-- ================================================== -->
                <!-- ============== DEVICE PAGE ======================= -->
                <!-- ================================================== -->
                <main id="device-page" class="p-4 lg:p-8 space-y-6 page-hidden">
                    <!-- Content is now rendered by JS -->
                </main>

                <!-- ================================================== -->
                <!-- ============== MEETING PAGE ====================== -->
                <!-- ================================================== -->
                <main id="meeting-page" class="p-4 lg:p-8 space-y-6 page-hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-100">会议记录</h1>
                        <div class="flex space-x-2">
                            <button id="refresh-meetings" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                刷新
                            </button>
                            <button id="clear-meetings" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                清空
                            </button>
                        </div>
                    </div>
                    <div id="meeting-container" class="bg-gray-800 rounded-xl p-4 lg:p-6 shadow-lg max-h-[calc(100vh-200px)] overflow-y-auto space-y-6 w-full box-border">
                        <!-- Meeting records will be loaded here -->
                        <div class="text-center text-gray-500 py-10" id="loading-meetings">
                            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto mb-4"></div>
                            <p>正在加载会议记录...</p>
                        </div>
                        <div id="no-meetings" class="text-center text-gray-500 py-10 hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                            <p>暂无会议记录</p>
                        </div>
                        <div id="meeting-list" class="space-y-4 hidden"></div>
                    </div>
                </main>

                <!-- ================================================== -->
                <!-- ============== CHAT PAGE ========================= -->
                <!-- ================================================== -->
                <main id="chat-page" class="p-4 lg:p-8 space-y-6 page-hidden">
                    <!-- 顶部标题栏 -->
                    <div class="glass-card rounded-2xl p-6 mb-6">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                    </svg>
                                </div>
                                <div>
                                    <h1 class="text-2xl font-bold text-white gradient-text">麦粒智能助手</h1>
                                    <p class="text-gray-400 text-sm">您的专属AI烹饪顾问</p>
                                </div>
                            </div>
                            <div class="flex space-x-3">
                                <button id="refresh-chats" class="btn-enhanced bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 py-2 rounded-xl transition flex items-center shadow-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                    刷新
                                </button>
                                <button id="clear-chats" class="btn-enhanced bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white px-4 py-2 rounded-xl transition flex items-center shadow-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    清空
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 聊天容器 -->
                    <div class="glass-card rounded-2xl overflow-hidden shadow-2xl">
                        <div id="chat-container" class="h-[calc(100vh-280px)] lg:h-[calc(100vh-320px)] overflow-y-auto">
                            <!-- 加载状态 -->
                            <div class="text-center text-gray-400 py-16" id="loading-chats">
                                <div class="relative mx-auto mb-6">
                                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-gray-600 border-t-blue-500 mx-auto"></div>
                                    <div class="absolute inset-0 rounded-full bg-gradient-to-r from-blue-500/20 to-purple-500/20 animate-pulse"></div>
                                </div>
                                <p class="text-lg font-medium">正在加载聊天记录...</p>
                                <p class="text-sm text-gray-500 mt-2">请稍候片刻</p>
                            </div>
                            
                            <!-- 无聊天记录状态 -->
                            <div id="no-chats" class="text-center text-gray-400 py-16 hidden">
                                <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-gray-700 to-gray-800 rounded-full flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                    </svg>
                                </div>
                                <h3 class="text-xl font-semibold text-gray-300 mb-2">暂无聊天记录</h3>
                                <p class="text-gray-500">开始与麦粒智能助手对话吧！</p>
                            </div>
                            
                            <!-- 聊天消息容器 -->
                            <div id="chat-messages" class="p-6 space-y-6 hidden"></div>
                        </div>
                    </div>
                </main>

                <!-- ================================================== -->
                <!-- ============== MEDIA PAGE ======================== -->
                <!-- ================================================== -->
                <main id="media-page" class="p-4 lg:p-8 space-y-6 page-hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-100">媒体库</h1>
                        <div class="flex space-x-2">
                            <button id="refresh-media" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                刷新
                            </button>
                        </div>
                    </div>
                    
                    <!-- 媒体类型切换 -->
                    <div class="bg-gray-800 rounded-xl p-4 mb-6">
                        <div class="flex space-x-4">
                            <button id="show-photos" class="media-type-btn bg-blue-600 text-white px-4 py-2 rounded-lg transition flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                照片
                            </button>
                            <button id="show-videos" class="media-type-btn bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                视频
                            </button>
                        </div>
                    </div>
                    
                    <!-- 照片网格 -->
                    <div id="photos-section" class="space-y-6">
                        <h2 class="text-xl font-semibold text-gray-100">照片</h2>
                        <div id="photos-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
                            <!-- 照片将在这里显示 -->
                        </div>
                        <div class="text-center text-gray-500 py-10" id="loading-photos">
                            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto mb-4"></div>
                            <p>正在加载照片...</p>
                        </div>
                        <div id="no-photos" class="text-center text-gray-500 py-10 hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            <p>暂无照片</p>
                        </div>
                    </div>
                    
                    <!-- 视频列表 -->
                    <div id="videos-section" class="space-y-6 hidden">
                        <h2 class="text-xl font-semibold text-gray-100">视频</h2>
                        <div id="videos-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- 视频将在这里显示 -->
                        </div>
                        <div class="text-center text-gray-500 py-10" id="loading-videos">
                            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto mb-4"></div>
                            <p>正在加载视频...</p>
                        </div>
                        <div id="no-videos" class="text-center text-gray-500 py-10 hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                            <p>暂无视频</p>
                        </div>
                    </div>
                </main>
                
                <!-- ================================================== -->
                <!-- ============== FOOD PAGE ========================= -->
                <!-- ================================================== -->
                <main id="food-page" class="p-4 lg:p-8 space-y-6 page-hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-100">食品记录</h1>
                        <div class="flex space-x-2">
                            <button id="refresh-foods" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                刷新
                            </button>
                        </div>
                    </div>
                    
                    <!-- 日期选择器 -->
                    <div class="bg-gray-800 rounded-xl p-4 mb-6">
                        <div class="flex items-center justify-between">
                            <button id="prev-day" class="text-gray-400 hover:text-white transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                            </button>
                            <h2 id="current-date" class="text-lg font-semibold text-white">2025年7月21日</h2>
                            <button id="next-day" class="text-gray-400 hover:text-white transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                            </button>
                        </div>
                    </div>

                    <!-- 餐次分类 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div id="breakfast-section" class="bg-gray-800 rounded-xl p-4">
                            <h3 class="text-lg font-semibold text-orange-400 mb-3 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                                早餐
                            </h3>
                            <div id="breakfast-items" class="space-y-2">
                                <!-- 早餐项目将在这里显示 -->
                            </div>
                        </div>
                        
                        <div id="lunch-section" class="bg-gray-800 rounded-xl p-4">
                            <h3 class="text-lg font-semibold text-yellow-400 mb-3 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                                午餐
                            </h3>
                            <div id="lunch-items" class="space-y-2">
                                <!-- 午餐项目将在这里显示 -->
                            </div>
                        </div>
                        
                        <div id="dinner-section" class="bg-gray-800 rounded-xl p-4">
                            <h3 class="text-lg font-semibold text-purple-400 mb-3 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                                晚餐
                            </h3>
                            <div id="dinner-items" class="space-y-2">
                                <!-- 晚餐项目将在这里显示 -->
                            </div>
                        </div>
                        
                        <div id="snack-section" class="bg-gray-800 rounded-xl p-4">
                            <h3 class="text-lg font-semibold text-blue-400 mb-3 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                                宵夜
                            </h3>
                            <div id="snack-items" class="space-y-2">
                                <!-- 宵夜项目将在这里显示 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 加载状态 -->
                    <div class="text-center text-gray-500 py-10" id="loading-foods">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto mb-4"></div>
                        <p>正在加载食品记录...</p>
                    </div>
                    
                    <!-- 无数据状态 -->
                    <div id="no-foods" class="text-center text-gray-500 py-10 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16l3-3m-3 3l-3-3" /></svg>
                        <p>今日暂无食品记录</p>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- 食品详情模态框 -->
    <div id="food-detail-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 modal-overlay modal-hidden">
        <div class="bg-gray-800 text-white p-6 rounded-xl shadow-2xl w-11/12 max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">食品详情</h3>
                <button id="close-food-detail" class="text-gray-400 hover:text-white transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="food-detail-content">
                <!-- 食品详情内容将在这里显示 -->
            </div>
        </div>
    </div>

    <!-- Overlays and Modals -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 modal-overlay modal-hidden">
        <div class="bg-gray-800 text-white p-6 rounded-lg flex items-center gap-4 modal-content">
            <svg class="animate-spin h-6 w-6 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span>正在发送...</span>
        </div>
    </div>

    <div id="brightness-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 modal-overlay modal-hidden">
        <div class="bg-gray-800 text-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm space-y-4 modal-content">
            <h3 class="text-lg font-semibold">调整亮度</h3>
            <input id="brightness-slider" type="range" min="0" max="100" value="70" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
            <button id="close-modal-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">完成</button>
        </div>
    </div>


    <!-- ================================================== -->
    <!-- ============ JAVASCRIPT LOGIC ==================== -->
    <!-- ================================================== -->
    <script type="module">
        // Import Three.js and essential addons
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';

        /**
         * @description Central data store for the application prototype.
         * Now expanded with more data for a richer desktop experience.
         */
        const DEMO_DATA = {
            userProfile: { name: "Efim" },
            dailyPlan: {
                title: "今日膳食计划",
                meals: [
                    { name: "早餐", recipeId: 2, status: "已完成" },
                    { name: "午餐", recipeId: 1, status: "计划中" },
                    { name: "晚餐", recipeId: 4, status: "未开始" },
                ]
            },
            quickActions: [
                { name: "扫描食材", icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>` },
                { name: "创建新菜谱", icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z" /></svg>` },
            ],
            nutrition: {
                daily: {
                    totalCalories: 29,
                    nutrients: [
                        { name: "蛋白质", value: 15, total: 60, unit: "g", color: "#3B82F6" },
                        { name: "碳水化合物", value: 5, total: 130, unit: "g", color: "#10B981" },
                        { name: "脂肪", value: 9, total: 50, unit: "g", color: "#F59E0B" },
                        { name: "纤维", value: 12, total: 30, unit: "g", color: "#8B5CF6" },
                    ]
                },
                weekly: { totalCalories: 1850, nutrients: [ { name: "蛋白质", value: 400, total: 420, unit: "g", color: "#3B82F6" }, { name: "碳水化合物", value: 850, total: 910, unit: "g", color: "#10B981" }, { name: "脂肪", value: 600, total: 350, unit: "g", color: "#F59E0B" } ] },
                monthly: { totalCalories: 7500, nutrients: [ { name: "蛋白质", value: 1600, total: 1800, unit: "g", color: "#3B82F6" }, { name: "碳水化合物", value: 3500, total: 3900, unit: "g", color: "#10B981" }, { name: "脂肪", value: 2400, total: 1500, unit: "g", color: "#F59E0B" } ] }
            },
            recipes: [
                { id: 1, name: "番茄炒蛋", time: 15, calories: 280, image: "https://placehold.co/400x300/f87171/white?text=番茄炒蛋", description: "一道简单快手的家常菜，营养丰富，老少皆宜。", difficulty: "简单", tags: ["家常菜", "快手菜"], ingredients: ["番茄 2个", "鸡蛋 3个", "葱 1根", "盐 适量"], steps: ["鸡蛋打散，番茄切块。", "热油炒鸡蛋，盛出。", "再热油炒番茄，加入鸡蛋。", "加盐调味，撒上葱花。"] },
                { id: 2, name: "清炒西兰花", time: 10, calories: 150, image: "https://placehold.co/400x300/4ade80/white?text=清炒西兰花", description: "保持蔬菜原有的鲜味和营养，健康饮食的首选。", difficulty: "简单", tags: ["素食", "健康"], ingredients: ["西兰花 1颗", "大蒜 2瓣", "盐 适量"], steps: ["西兰花掰成小块，洗净。", "大蒜切片。", "热油爆香大蒜，放入西兰花翻炒。", "加少许水焖熟，加盐调味。"] },
                { id: 3, name: "可乐鸡翅", time: 25, calories: 450, image: "https://placehold.co/400x300/ca8a04/white?text=可乐鸡翅", description: "甜咸可口，色泽诱人，是孩子们的最爱。", difficulty: "中等", tags: ["荤菜", "下饭菜"], ingredients: ["鸡翅中 8个", "可乐 1罐", "姜 3片", "酱油 适量"], steps: ["鸡翅焯水，捞出。", "热油煎鸡翅至两面金黄。", "加入姜片、酱油和可乐。", "大火烧开，转小火慢炖至汤汁浓稠。"] },
                { id: 4, name: "蒜蓉粉丝虾", time: 20, calories: 320, image: "https://placehold.co/400x300/60a5fa/white?text=蒜蓉粉丝虾", description: "鲜美的虾与蒜蓉的香味完美结合，宴客佳品。", difficulty: "中等", tags: ["海鲜", "宴客菜"], ingredients: ["大虾 8只", "粉丝 1把", "大蒜 1头", "小米椒 2个"], steps: ["粉丝泡软，铺在盘底。", "大虾开背去虾线，放在粉丝上。", "蒜蓉、小米椒、酱油、油混合，淋在虾上。", "上锅蒸10分钟即可。"] },
            ],
            chatHistory: [
                { timestamp: "2025-07-17 20:43:10", question: "莫斯科你好", answer: "你好！很高兴能为你提供帮助。有什么我可以帮你吗？" },
                { timestamp: "2025-07-17 20:43:35", question: "莫斯科你好请拍照", answer: "好的，请告诉我您需要拍摄什么内容？", photo: "photos/20250717_204333.jpg" },
                { timestamp: "2025-07-17 21:02:36", question: "莫斯科及拍照", answer: "这是一张模糊的照片，显示了一个办公环境。可以看到一个桌子，上面放着一些物品，如一个黑色的鼠标、一个绿色的瓶子和一个红色的外套挂在椅子上。背景中有一个电脑显示器，显示器前面有一个人的部分身体，但无法看清具体细节。整体环境看起来像是一个办公室或学习空间。由于照片模糊，无法提供更详细的描述。", photo: "photos/20250717_210231.jpg" },
                { timestamp: "2025-07-17 21:03:07", question: "莫斯科请拍照", answer: "好的，我已经拍到了这张图片。请问您需要我做什么呢？", photo: "photos/20250717_210305.jpg" },
                { timestamp: "2025-07-17 21:03:27", question: "莫斯科请拍照", answer: "好的，我会尽力帮助您拍照。请告诉我您需要拍摄的具体内容或场景，我会根据您的要求进行拍照。", photo: "photos/20250717_210326.jpg" }
            ],
            device: {
                name: "智能烹饪眼镜X1",
                isConnected: true,
                battery: 85,
                firmware: "v1.2.5",
                settings: {
                    brightness: 70, 
                    notifications: true,
                    hapticFeedback: "中", // 新增
                    displayProfile: "标准" // 新增
                }
            }
        };

        // --- DOM Element Selectors ---
        const pages = document.querySelectorAll('main');
        const navButtons = document.querySelectorAll('.nav-btn');
        const overlays = {
            loading: document.getElementById('loading-overlay'),
            brightnessModal: document.getElementById('brightness-modal'),
        };

        let threeScene = null; // To hold the Three.js scene context

        /**
         * @description Animates a numerical value in a DOM element.
         */
        function animateValue(el, target, duration = 500) {
            if (!el) return;
            let start = parseInt(el.textContent) || 0;
            let startTime = null;
            function step(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = Math.min((timestamp - startTime) / duration, 1);
                el.textContent = Math.floor(progress * (target - start) + start);
                if (progress < 1) requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

        /**
         * @description Handles single-page navigation with transitions.
         */
        /**
         * Loads meeting records from server and renders them
         */
        async function loadMeetingRecords() {
            const meetingContainer = document.getElementById('meeting-list');
            const loadingIndicator = document.getElementById('loading-meetings');
            const noMeetingsIndicator = document.getElementById('no-meetings');

            // Show loading state
            meetingContainer.classList.add('hidden');
            noMeetingsIndicator.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');

            try {
                // Fetch list of meeting files from server
                const meetingUrl = '../meeting_recording/';
                console.log('Fetching meeting list from:', meetingUrl);
                const response = await fetch(meetingUrl);
                console.log('Meeting fetch response:', response.url, response.status);
                if (!response.ok) throw new Error('Failed to fetch meeting file list');
                const html = await response.text();

                // Parse HTML to extract .txt files (simplified parser)
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const links = Array.from(doc.querySelectorAll('a[href$="_meeting.txt"]'))
                    .map(a => a.href.split('/').pop())
                    .sort((a, b) => new Date(b.split('_')[1]) - new Date(a.split('_')[1]));

                if (links.length === 0) {
                    loadingIndicator.classList.add('hidden');
                    noMeetingsIndicator.classList.remove('hidden');
                    return;
                }

                // Clear existing meetings
                meetingContainer.innerHTML = '';

                // Load and parse each meeting file
                for (const filename of links) {
                    const meetingFileUrl = `../meeting_recording/${filename}`;
                    console.log('Fetching meeting file from:', meetingFileUrl);
                    const meetingResponse = await fetch(meetingFileUrl);
                    console.log('Meeting file fetch response:', meetingResponse.url, meetingResponse.status);
                    if (!meetingResponse.ok) continue;
                    const content = await meetingResponse.text();

                    // Extract timestamp from filename (YYYYMMDD_HHMMSS_meeting.txt)
                    const timestampStr = filename.match(/(\d{8})_(\d{6})_meeting\.txt/);
                    if (!timestampStr) continue;

                    const date = new Date(`${timestampStr[1].slice(0,4)}-${timestampStr[1].slice(4,6)}-${timestampStr[1].slice(6,8)}T${timestampStr[2].slice(0,2)}:${timestampStr[2].slice(2,4)}:${timestampStr[2].slice(4,6)}`);
                    const formattedTime = date.toLocaleString('zh-CN', { 
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit'
                    });

                    // Extract meeting duration and content preview
                    const lines = content.split('\n').filter(line => line.trim() !== '');
                    const contentLines = lines.filter(line => line.startsWith('[') && line.includes(']'));
                    const duration = contentLines.length > 0 ? `${contentLines.length} 条记录` : '无记录';
                    const preview = contentLines.slice(0, 3).map(line => line.replace(/^\[\d{2}:\d{2}:\d{2}\]\s*/, '')).join(' | ');

                    // Create meeting record element
                    const meetingEl = document.createElement('div');
                    meetingEl.className = 'meeting-record fade-in-up opacity-0 bg-gray-700 rounded-lg p-4 cursor-pointer hover:bg-gray-600 transition-colors';
                    meetingEl.style.animationDelay = `${links.indexOf(filename) * 0.1}s`;
                    meetingEl.dataset.filename = filename;

                    meetingEl.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-semibold text-gray-100">会议记录</h3>
                            <span class="text-xs text-gray-400">${formattedTime}</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-blue-400">${duration}</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </div>
                        <p class="text-sm text-gray-300 truncate">${preview || '点击查看详细内容'}</p>
                    `;

                    // Add click event to show meeting details
                    meetingEl.addEventListener('click', () => showMeetingDetail(filename, content, formattedTime));

                    meetingContainer.appendChild(meetingEl);

                    // Trigger animation after render
                    setTimeout(() => meetingEl.classList.remove('opacity-0'), 10);
                }

                // Show meeting list
                loadingIndicator.classList.add('hidden');
                meetingContainer.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading meeting records:', error);
                loadingIndicator.classList.add('hidden');
                noMeetingsIndicator.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p>加载会议记录失败</p>
                `;
                noMeetingsIndicator.classList.remove('hidden');
            }
        }

        /**
         * Shows meeting detail in a modal or detailed view
         */
        function showMeetingDetail(filename, content, formattedTime) {
            // Create modal for meeting detail
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
                    <div class="flex justify-between items-center p-6 border-b border-gray-700">
                        <div>
                            <h2 class="text-xl font-bold text-gray-100">会议记录详情</h2>
                            <p class="text-sm text-gray-400">${formattedTime}</p>
                        </div>
                        <button class="close-modal text-gray-400 hover:text-gray-200 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                        <pre class="text-gray-300 text-sm whitespace-pre-wrap font-mono bg-gray-900 p-4 rounded-lg">${content}</pre>
                    </div>
                </div>
            `;

            // Add close functionality
            modal.querySelector('.close-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });

            document.body.appendChild(modal);
        }

        /**
         * Clears all meeting records
         */
        function clearMeetingRecords() {
            const meetingContainer = document.getElementById('meeting-list');
            const noMeetingsIndicator = document.getElementById('no-meetings');

            // Add fade out animation
            meetingContainer.classList.add('opacity-0');
            setTimeout(() => {
                meetingContainer.innerHTML = '';
                meetingContainer.classList.add('hidden');
                meetingContainer.classList.remove('opacity-0');
                noMeetingsIndicator.classList.remove('hidden');
            }, 300);
        }

        /**
         * @description Renders the meeting page content.
         */
        function renderMeetingPage() {
            // Meeting page content is already in HTML, just ensure it's properly initialized
            console.log('Meeting page rendered');
        }

        /**
         * Loads chat history from server and renders messages
         */
        async function loadChatHistory() {
    // 使用相对路径访问资源
    console.log('Using relative paths for resource access');
            const chatContainer = document.getElementById('chat-messages');
            const loadingIndicator = document.getElementById('loading-chats');
            const noChatsIndicator = document.getElementById('no-chats');

            // Show loading state
            chatContainer.classList.add('hidden');
            noChatsIndicator.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');

            try {
                // Fetch list of history files from server
                const historyUrl = '../history/';
    console.log('Fetching history list from:', historyUrl);
    const response = await fetch(historyUrl);
    console.log('History fetch response:', response.url, response.status);
                if (!response.ok) throw new Error('Failed to fetch file list');
                const html = await response.text();

                // Parse HTML to extract .txt files (simplified parser)
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const links = Array.from(doc.querySelectorAll('a[href$=".txt"]'))
                    .map(a => a.href.split('/').pop())
                    .sort((a, b) => new Date(a.split('_')[1].replace('.txt','')) - new Date(b.split('_')[1].replace('.txt','')));

                if (links.length === 0) {
                    loadingIndicator.classList.add('hidden');
                    noChatsIndicator.classList.remove('hidden');
                    return;
                }

                // Clear existing messages
                chatContainer.innerHTML = '';

                // Load and parse each chat file
                for (const filename of links) {
                    const chatUrl = `../history/${filename}`;
    console.log('Fetching chat file from:', chatUrl);
    const chatResponse = await fetch(chatUrl);
    console.log('Chat file fetch response:', chatResponse.url, chatResponse.status);
                    if (!chatResponse.ok) continue;
                    const content = await chatResponse.text();

                    // Parse chat content
                    const lines = content.split('\n').filter(line => line.trim() !== '');
                    if (lines.length < 2) continue;

                    const question = lines[0].replace('Q: ', '').trim();
                    const answer = lines[1].replace('A: ', '').trim();
                    let photo = null;
                    if (lines.length >= 3 && lines[2].startsWith('Photo: ')) {
                        photo = lines[2].replace('Photo: ', '').trim();
                    }

                    // Extract timestamp from filename (response_YYYYMMDD_HHMMSS.txt)
                    const timestampStr = filename.match(/response_(\d{8})_(\d{6})\.txt/);
                    if (!timestampStr) continue;

                    const date = new Date(`${timestampStr[1].slice(0,4)}-${timestampStr[1].slice(4,6)}-${timestampStr[1].slice(6,8)}T${timestampStr[2].slice(0,2)}:${timestampStr[2].slice(2,4)}:${timestampStr[2].slice(4,6)}`);
                    const formattedTime = date.toLocaleString('zh-CN', { 
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit'
                    });

                    // Create chat message element
                    const messageEl = document.createElement('div');
                    messageEl.className = 'chat-message fade-in-up opacity-0';
                    messageEl.style.animationDelay = `${links.indexOf(filename) * 0.1}s`;

                    messageEl.innerHTML = `
                        <!-- 时间戳 -->
                        <div class="text-center mb-4">
                            <span class="inline-block px-3 py-1 bg-gray-700/50 text-gray-400 text-xs rounded-full backdrop-blur-sm">${formattedTime}</span>
                        </div>
                        
                        <!-- 用户消息 -->
                        <div class="flex items-end justify-end mb-4 group">
                            <div class="flex flex-col items-end max-w-[75%] lg:max-w-[60%]">
                                <div class="relative">
                                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-2xl rounded-br-md px-4 py-3 shadow-lg">
                                        <p class="text-sm leading-relaxed">${question}</p>
                                        ${photo ? `<div class="mt-3 rounded-xl overflow-hidden border border-blue-400/50 transition-all duration-300 hover:scale-[1.02] hover:shadow-xl">
                                            <img src="../photos/${photo.split('/').pop()}" alt="聊天图片" class="w-full h-auto object-cover" loading="lazy" onError="this.src='https://via.placeholder.com/300x200?text=图片加载失败'; console.error('Failed to load image:', '../photos/${photo.split('/').pop()}');">
                                        </div>` : ''}
                                    </div>
                                    <!-- 消息尾巴 -->
                                    <div class="absolute -bottom-0 -right-0 w-4 h-4 bg-blue-600 transform rotate-45 translate-x-2 translate-y-2"></div>
                                </div>
                                <div class="flex items-center mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <span class="text-xs text-gray-500 mr-2">您</span>
                                    <div class="w-6 h-6 bg-gradient-to-br from-blue-400 to-blue-500 rounded-full flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-white" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI回复 -->
                        <div class="flex items-end justify-start group">
                            <div class="flex flex-col items-start max-w-[75%] lg:max-w-[60%]">
                                <div class="flex items-center mb-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <div class="w-6 h-6 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center mr-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                        </svg>
                                    </div>
                                    <span class="text-xs text-gray-500">麦粒助手</span>
                                </div>
                                <div class="relative">
                                    <div class="bg-gradient-to-br from-gray-700 to-gray-800 text-white rounded-2xl rounded-bl-md px-4 py-3 shadow-lg border border-gray-600/30">
                                        <p class="text-sm leading-relaxed">${answer}</p>
                                    </div>
                                    <!-- 消息尾巴 -->
                                    <div class="absolute -bottom-0 -left-0 w-4 h-4 bg-gray-800 transform rotate-45 -translate-x-2 translate-y-2"></div>
                                </div>
                            </div>
                        </div>
                    `;

                    chatContainer.insertBefore(messageEl, chatContainer.firstChild);

                    // Trigger animation after render
                    setTimeout(() => messageEl.classList.remove('opacity-0'), 10);
                }

                // Show chat messages
                loadingIndicator.classList.add('hidden');
                chatContainer.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading chat history:', error);
                loadingIndicator.classList.add('hidden');
                noChatsIndicator.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p>加载聊天记录失败</p>
                `;
                noChatsIndicator.classList.remove('hidden');
            }
        }

        /**
         * Clears all chat messages
         */
        function clearChatHistory() {
            const chatContainer = document.getElementById('chat-messages');
            const noChatsIndicator = document.getElementById('no-chats');

            // Add fade out animation
            chatContainer.classList.add('opacity-0');
            setTimeout(() => {
                chatContainer.innerHTML = '';
                chatContainer.classList.add('hidden');
                chatContainer.classList.remove('opacity-0');
                noChatsIndicator.classList.remove('hidden');
            }, 300);
        }

        // 全局变量存储食品记录
        let globalFoodRecords = [];

        /**
         * 加载食品识别记录
         */
        async function loadFoodRecords() {
            try {
                const response = await fetch('/food_recognition/');
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const links = Array.from(doc.querySelectorAll('a'))
                    .map(link => link.textContent.trim())
                    .filter(filename => filename.endsWith('.json'));
                
                const records = [];
                for (const filename of links) {
                    try {
                        const recordResponse = await fetch(`/food_recognition/${filename}`);
                        const recordData = await recordResponse.text();
                        const record = JSON.parse(recordData);
                        records.push(record);
                    } catch (error) {
                        console.error(`解析食品记录 ${filename} 失败:`, error);
                    }
                }
                
                globalFoodRecords = records;
                return records;
            } catch (error) {
                console.error('加载食品记录失败:', error);
                return [];
            }
        }

        /**
         * 根据时间判断餐次
         */
        function getMealTime(datetime) {
            const hour = new Date(datetime).getHours();
            if (hour >= 6 && hour < 10) return 'breakfast';
            if (hour >= 11 && hour < 14) return 'lunch';
            if (hour >= 17 && hour < 20) return 'dinner';
            return 'snack';
        }

        /**
         * 按日期和餐次分组食品记录
         */
        function groupFoodRecordsByDate(records) {
            const grouped = {};
            
            records.forEach(record => {
                const date = record.datetime.split(' ')[0];
                const mealTime = getMealTime(record.datetime);
                
                if (!grouped[date]) {
                    grouped[date] = {
                        breakfast: [],
                        lunch: [],
                        dinner: [],
                        snack: []
                    };
                }
                
                grouped[date][mealTime].push(record);
            });
            
            return grouped;
        }

        /**
         * 计算营养统计
         */
        function calculateNutritionStats(records, period = 'daily') {
            const stats = {
                calories: 0,
                protein: 0,
                fat: 0,
                carbs: 0,
                fiber: 0,
                sodium: 0,
                calcium: 0,
                iron: 0
            };
            
            const now = new Date();
            const filteredRecords = records.filter(record => {
                const recordDate = new Date(record.datetime);
                if (period === 'daily') {
                    return recordDate.toDateString() === now.toDateString();
                } else if (period === 'weekly') {
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return recordDate >= weekAgo;
                } else if (period === 'monthly') {
                    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    return recordDate >= monthAgo;
                }
                return true;
            });
            
            filteredRecords.forEach(record => {
                if (record.nutrients) {
                    // 根据24种营养素的正确顺序获取数值
                    const nutrientValues = Object.values(record.nutrients);
                    
                    // 按照正确的索引位置获取营养素值
                    // 0:可食部分 1:水分 2:能量 3:蛋白质 4:脂肪 5:碳水化合物 6:膳食纤维
                    // 7:胆固醇 8:维生素A 9:维生素B1 10:维生素B2 11:维生素B3 12:维生素C 13:维生素E
                    // 14:钙 15:磷 16:钾 17:钠 18:镁 19:铁 20:锌 21:硒 22:铜 23:锰
                    if (nutrientValues[2]) stats.calories += parseFloat(nutrientValues[2]) || 0;  // 能量
                    if (nutrientValues[3]) stats.protein += parseFloat(nutrientValues[3]) || 0;   // 蛋白质
                    if (nutrientValues[4]) stats.fat += parseFloat(nutrientValues[4]) || 0;       // 脂肪
                    if (nutrientValues[5]) stats.carbs += parseFloat(nutrientValues[5]) || 0;     // 碳水化合物
                    if (nutrientValues[6]) stats.fiber += parseFloat(nutrientValues[6]) || 0;     // 膳食纤维
                    if (nutrientValues[17]) stats.sodium += parseFloat(nutrientValues[17]) || 0;  // 钠
                    if (nutrientValues[14]) stats.calcium += parseFloat(nutrientValues[14]) || 0; // 钙
                    if (nutrientValues[19]) stats.iron += parseFloat(nutrientValues[19]) || 0;    // 铁
                }
            });
            
            return stats;
        }

        /**
         * 更新营养宝塔显示
         */
        function updateNutritionPyramid(stats, period = 'daily') {
            // 根据时间周期调整推荐摄入量的倍数
            let multiplier = 1;
            if (period === 'weekly') {
                multiplier = 7;
            } else if (period === 'monthly') {
                multiplier = 30;
            }
            
            // 中国膳食宝塔推荐摄入量（成人每日）
            const recommendations = {
                '油脂': { current: stats.fat, recommended: 25 * multiplier, unit: 'g' },
                '奶类': { current: stats.protein * 6, recommended: 300 * multiplier, unit: 'g' },
                '肉类': { current: stats.protein * 5, recommended: 120 * multiplier, unit: 'g' },
                '果蔬': { current: stats.fiber * 20, recommended: 500 * multiplier, unit: 'g' },
                '谷物': { current: stats.carbs * 1.2, recommended: 250 * multiplier, unit: 'g' }
            };
            
            Object.keys(recommendations).forEach(nutrient => {
                const layer = document.querySelector(`[data-nutrient="${nutrient}"]`);
                if (layer) {
                    const progress = layer.querySelector('.layer-progress');
                    const valueSpan = layer.querySelector('.layer-value');
                    
                    const { current, recommended, unit } = recommendations[nutrient];
                    const percentage = (current / recommended) * 100;
                    const isOverflow = percentage > 100;
                    
                    // 设置进度条宽度，最大100%
                    progress.style.width = `${Math.min(percentage, 100)}%`;
                    valueSpan.textContent = `${current.toFixed(1)}/${recommended}${unit}`;
                    
                    // 处理超出限制的情况
                    if (isOverflow) {
                        layer.classList.add('overflow');
                        progress.classList.add('overflow');
                        
                        // 添加震动效果
                        setTimeout(() => {
                            layer.classList.remove('overflow');
                        }, 500);
                    } else {
                        layer.classList.remove('overflow');
                        progress.classList.remove('overflow');
                    }
                }
            });
            
            // 更新总卡路里
            const totalCaloriesElement = document.getElementById('total-calories');
            if (totalCaloriesElement) {
                animateValue(totalCaloriesElement, Math.round(stats.calories));
            }
        }

        /**
         * 渲染食品页面
         */
        async function renderFoodPage() {
            const loadingIndicator = document.getElementById('loading-foods');
            const noFoodsIndicator = document.getElementById('no-foods');
            
            // 显示加载状态
            loadingIndicator.classList.remove('hidden');
            noFoodsIndicator.classList.add('hidden');
            
            try {
                const records = await loadFoodRecords();
                
                if (records.length === 0) {
                    loadingIndicator.classList.add('hidden');
                    noFoodsIndicator.classList.remove('hidden');
                    return;
                }
                
                const groupedRecords = groupFoodRecordsByDate(records);
                const dates = Object.keys(groupedRecords).sort().reverse();
                
                // 渲染每日食品记录
                const mealSections = {
                    breakfast: document.getElementById('breakfast-items'),
                    lunch: document.getElementById('lunch-items'),
                    dinner: document.getElementById('dinner-items'),
                    snack: document.getElementById('snack-items')
                };
                
                // 清空现有内容
                Object.values(mealSections).forEach(section => {
                    if (section) section.innerHTML = '';
                });
                
                // 显示今日记录
                const today = new Date().toISOString().split('T')[0];
                const todayRecords = groupedRecords[today] || { breakfast: [], lunch: [], dinner: [], snack: [] };
                
                Object.keys(todayRecords).forEach(mealType => {
                    const section = mealSections[mealType];
                    if (!section) return;
                    
                    todayRecords[mealType].forEach(record => {
                        const foodItem = document.createElement('div');
                        foodItem.className = 'food-item bg-gray-700 rounded-lg p-3 cursor-pointer hover:bg-gray-600 transition-colors';
                        
                        // 获取营养值数组，使用正确的能量索引
                        const nutrientValues = Object.values(record.nutrients || {});
                        const calories = parseFloat(nutrientValues[2] || 0).toFixed(2); // 能量(索引2)，保留两位小数
                        
                        foodItem.innerHTML = `
                            <div class="flex items-center gap-3">
                                <img src="${record.photo_path}" alt="${record.dish_name}" class="w-12 h-12 rounded-lg object-cover" onerror="this.src='https://via.placeholder.com/48x48?text=食物'">
                                <div class="flex-1">
                                    <h4 class="font-medium text-gray-100">${record.dish_name}</h4>
                                    <p class="text-sm text-gray-400">${calories} kcal</p>
                                </div>
                                <div class="text-xs text-gray-500">
                                    ${new Date(record.datetime).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                            </div>
                        `;
                        
                        foodItem.addEventListener('click', () => showFoodDetail(record));
                        section.appendChild(foodItem);
                    });
                });
                
                loadingIndicator.classList.add('hidden');
                
            } catch (error) {
                console.error('渲染食品页面失败:', error);
                loadingIndicator.classList.add('hidden');
                noFoodsIndicator.classList.remove('hidden');
            }
        }

        /**
         * 显示食品详情
         */
        function showFoodDetail(record) {
            const modal = document.getElementById('food-detail-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-100">${record.dish_name}</h3>
                    <button class="close-modal text-gray-400 hover:text-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <img src="${record.photo_path}" alt="${record.dish_name}" class="w-full rounded-lg object-cover" onerror="this.src='https://via.placeholder.com/300x200?text=食物图片'">
                        <div class="mt-4">
                            <p class="text-sm text-gray-400">识别时间: ${record.datetime}</p>
                            <p class="text-sm text-gray-400">置信度: ${(record.confidence * 100).toFixed(1)}%</p>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-200 mb-3">营养成分</h4>
                        <div class="space-y-2">
                            ${(() => {
                                const nutrientValues = Object.values(record.nutrients || {});
                                const nutrientLabels = ['可食部分(%)', '水分(g)', '能量(kcal)', '蛋白质(g)', '脂肪(g)', '碳水化合物(g)', '膳食纤维(g)', '胆固醇(mg)', '维生素A(μg)', '维生素B1(mg)', '维生素B2(mg)', '维生素B3(mg)', '维生素C(mg)', '维生素E(mg)', '钙(mg)', '磷(mg)', '钾(mg)', '钠(mg)', '镁(mg)', '铁(mg)', '锌(mg)', '硒(μg)', '铜(mg)', '锰(mg)'];
                                return nutrientValues.map((value, index) => {
                                    const label = nutrientLabels[index] || `营养素${index + 1}`;
                                    return `
                                        <div class="flex justify-between">
                                            <span class="text-gray-300">${label}</span>
                                            <span class="text-gray-100">${value}</span>
                                        </div>
                                    `;
                                }).join('');
                            })()} 
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
            
            // 添加关闭功能
            modal.querySelector('.close-modal').addEventListener('click', () => {
                modal.classList.remove('modal-visible');
                modal.classList.add('modal-hidden');
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('modal-visible');
                    modal.classList.add('modal-hidden');
                }
            });
        }

        function navigateTo(pageId) {
            const targetPage = document.getElementById(pageId);
            if (!targetPage) return;

            pages.forEach(page => page.classList.add('page-hidden'));
            targetPage.classList.remove('page-hidden');
            
            navButtons.forEach(btn => {
                const isActive = btn.dataset.page === pageId;
                btn.classList.toggle('text-blue-400', isActive);
                btn.classList.toggle('bg-gray-700', isActive);
                btn.classList.toggle('text-gray-400', !isActive);
            });
            
            window.scrollTo(0, 0);

            if (pageId === 'device-page') {
                setTimeout(() => {
                    if (!threeScene) initThreeJS();
                }, 50);
            } else if (pageId === 'food-page') {
                setTimeout(() => {
                    renderFoodPage();
                }, 50);
            }
        }

        /**
         * @description Renders the home page dashboard.
         */
        async function renderHomePage(period = 'daily') {
            const pageEl = document.getElementById('home-page');
            
            pageEl.innerHTML = `
                <header class="flex justify-between items-center">
                    <h1 class="text-2xl lg:text-3xl font-bold text-gray-100">你好, ${DEMO_DATA.userProfile.name}</h1>
                    <div id="period-selector" class="flex bg-gray-800 rounded-full p-1" role="group">
                        <button data-period="daily" class="period-btn px-4 py-2 text-sm rounded-full transition-colors ${period === 'daily' ? 'bg-blue-600 text-white' : 'text-gray-300'}">日</button>
                        <button data-period="weekly" class="period-btn px-4 py-2 text-sm rounded-full transition-colors ${period === 'weekly' ? 'bg-blue-600 text-white' : 'text-gray-300'}">周</button>
                        <button data-period="monthly" class="period-btn px-4 py-2 text-sm rounded-full transition-colors ${period === 'monthly' ? 'bg-blue-600 text-white' : 'text-gray-300'}">月</button>
                    </div>
                </header>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                            <h2 class="text-lg font-semibold text-gray-200 mb-4">营养素摄入分析</h2>
                            <div class="flex flex-col items-center gap-6">
                                <div class="text-center mb-4">
                                    <span id="total-calories" class="text-4xl font-bold text-white">0</span>
                                    <span class="text-sm text-gray-400 block">总摄入 (Kcal)</span>
                                </div>
                                <div class="nutrition-pyramid w-full max-w-md">
                                    <div class="pyramid-layer pyramid-layer-1" data-nutrient="油脂">
                                        <div class="layer-progress" style="width: 0%"></div>
                                        <div class="layer-info">
                                            <span class="layer-name">油脂类</span>
                                            <span class="layer-value">0/25g</span>
                                        </div>
                                    </div>
                                    <div class="pyramid-layer pyramid-layer-2" data-nutrient="奶类">
                                        <div class="layer-progress" style="width: 0%"></div>
                                        <div class="layer-info">
                                            <span class="layer-name">奶类豆类</span>
                                            <span class="layer-value">0/300g</span>
                                        </div>
                                    </div>
                                    <div class="pyramid-layer pyramid-layer-3" data-nutrient="肉类">
                                        <div class="layer-progress" style="width: 0%"></div>
                                        <div class="layer-info">
                                            <span class="layer-name">肉蛋类</span>
                                            <span class="layer-value">0/120g</span>
                                        </div>
                                    </div>
                                    <div class="pyramid-layer pyramid-layer-4" data-nutrient="果蔬">
                                        <div class="layer-progress" style="width: 0%"></div>
                                        <div class="layer-info">
                                            <span class="layer-name">蔬果类</span>
                                            <span class="layer-value">0/500g</span>
                                        </div>
                                    </div>
                                    <div class="pyramid-layer pyramid-layer-5" data-nutrient="谷物">
                                        <div class="layer-progress" style="width: 0%"></div>
                                        <div class="layer-info">
                                            <span class="layer-name">谷薯类</span>
                                            <span class="layer-value">0/250g</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                             <h2 class="text-lg font-semibold text-gray-200 mb-4">详细数据</h2>
                             <div id="nutrition-details" class="space-y-4"></div>
                        </div>
                        <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                            <h2 class="text-lg font-semibold text-gray-200 mb-4 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                </svg>
                                麦粒评价
                            </h2>
                            <div id="nutrition-advice" class="space-y-4">
                                <div class="text-center text-gray-500 py-6" id="loading-advice">
                                    <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mx-auto mb-3"></div>
                                    <p class="text-sm">正在生成营养建议...</p>
                                </div>
                                
                                <!-- 营养评价区域 -->
                                <div id="nutrition-evaluation" class="hidden">
                                    <h3 class="text-md font-semibold text-gray-200 mb-2 flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                        </svg>
                                        营养评价
                                    </h3>
                                    <div id="evaluation-content" class="bg-gray-700/30 rounded-lg p-4 text-sm text-gray-300 leading-relaxed">
                                        <!-- 营养评价内容将在这里显示 -->
                                    </div>
                                </div>
                                
                                <!-- 饮食推荐区域 -->
                                <div id="diet-recommendation" class="hidden">
                                    <h3 class="text-md font-semibold text-gray-200 mb-2 flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                        </svg>
                                        饮食推荐
                                    </h3>
                                    <div id="recommendation-content" class="bg-gray-700/30 rounded-lg p-4 text-sm text-gray-300 leading-relaxed">
                                        <!-- 饮食推荐内容将在这里显示 -->
                                    </div>
                                </div>
                                
                                <div id="no-advice" class="text-center text-gray-500 py-6 hidden">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                    </svg>
                                    <p class="text-sm">暂无营养建议</p>
                                    <p class="text-xs text-gray-600 mt-1">识别食物后将自动生成建议</p>
                                </div>
                                
                                <div id="advice-error" class="text-center text-red-400 py-6 hidden">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                                    </svg>
                                    <p class="text-sm">加载失败</p>
                                    <p class="text-xs text-gray-600 mt-1">请稍后重试</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                            <h2 class="text-lg font-semibold text-gray-200 mb-4">${DEMO_DATA.dailyPlan.title}</h2>
                            <ul id="meal-plan-list" class="space-y-3"></ul>
                        </div>
                        <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                            <h2 class="text-lg font-semibold text-gray-200 mb-4">快捷操作</h2>
                            <div id="quick-actions-list" class="grid grid-cols-2 gap-4"></div>
                        </div>
                    </div>
                </div>
            `;

            // 加载真实的食品数据并更新营养宝塔
            try {
                if (globalFoodRecords.length === 0) {
                    await loadFoodRecords();
                }
                const stats = calculateNutritionStats(globalFoodRecords, period);
                updateNutritionPyramid(stats, period);
                
                // 更新详细数据显示
                const detailsEl = pageEl.querySelector('#nutrition-details');
                
                // 根据时间周期调整推荐值
                let multiplier = 1;
                if (period === 'weekly') {
                    multiplier = 7;
                } else if (period === 'monthly') {
                    multiplier = 30;
                }
                
                const nutritionDetails = [
                    { name: '蛋白质', value: stats.protein, total: 60 * multiplier, unit: 'g', color: '#3B82F6' },
                    { name: '碳水化合物', value: stats.carbs, total: 130 * multiplier, unit: 'g', color: '#10B981' },
                    { name: '脂肪', value: stats.fat, total: 50 * multiplier, unit: 'g', color: '#F59E0B' },
                    { name: '膳食纤维', value: stats.fiber, total: 30 * multiplier, unit: 'g', color: '#8B5CF6' },
                    { name: '钠', value: stats.sodium / 1000, total: 2.3 * multiplier, unit: 'g', color: '#EF4444' },
                    { name: '钙', value: stats.calcium, total: 800 * multiplier, unit: 'mg', color: '#06B6D4' },
                    { name: '铁', value: stats.iron, total: 15 * multiplier, unit: 'mg', color: '#84CC16' }
                ];
                
                detailsEl.innerHTML = '';
                nutritionDetails.forEach((n, i) => {
                    const percentage = n.total > 0 ? (n.value / n.total) * 100 : 0;
                    const item = document.createElement('div');
                    item.className = 'fade-in-up';
                    item.style.animationDelay = `${i * 100}ms`;
                    item.style.opacity = 0;
                    item.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-gray-200">${n.name}</span>
                            <span class="text-sm text-gray-400">${n.value.toFixed(1)}${n.unit} / ${n.total}${n.unit}</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5"><div class="h-2.5 rounded-full" style="width: ${Math.min(percentage, 100)}%; background-color: ${n.color};"></div></div>
                    `;
                    detailsEl.appendChild(item);
                    setTimeout(() => item.style.opacity = 1, i * 100);
                });
            } catch (error) {
                console.error('更新营养数据失败:', error);
                // 使用默认数据
                const nutritionData = DEMO_DATA.nutrition[period];
                if (nutritionData) {
                    animateValue(pageEl.querySelector('#total-calories'), nutritionData.totalCalories);
                }
            }

            const mealPlanList = pageEl.querySelector('#meal-plan-list');
            mealPlanList.innerHTML = '';
            DEMO_DATA.dailyPlan.meals.forEach(meal => {
                const recipe = DEMO_DATA.recipes.find(r => r.id === meal.recipeId);
                mealPlanList.innerHTML += `
                    <li class="flex items-center justify-between p-3 bg-gray-700/50 rounded-lg hover:bg-gray-700 transition cursor-pointer">
                        <div>
                            <span class="font-semibold text-gray-200">${meal.name}</span>
                            <p class="text-sm text-gray-400">${recipe.name}</p>
                        </div>
                        <span class="text-xs font-medium px-2 py-1 rounded-full ${meal.status === '已完成' ? 'bg-green-500/20 text-green-400' : 'bg-blue-500/20 text-blue-400'}">${meal.status}</span>
                    </li>`;
            });

            const quickActionsList = pageEl.querySelector('#quick-actions-list');
            quickActionsList.innerHTML = '';
            DEMO_DATA.quickActions.forEach(action => {
                quickActionsList.innerHTML += `
                    <button class="bg-gray-700/50 rounded-lg p-4 flex flex-col items-center justify-center gap-2 hover:bg-gray-700 transition">
                        ${action.icon}
                        <span class="text-sm text-gray-300">${action.name}</span>
                    </button>`;
            });

            pageEl.querySelector('#period-selector').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') renderHomePage(e.target.dataset.period);
            });
            
            // 加载营养建议
            loadNutritionAdvice();
        }

        /**
         * @description Renders the recipe cards on the Recipes page.
         */
        function renderRecipesPage() {
            const pageEl = document.getElementById('recipes-page');
            pageEl.innerHTML = `
                <header class="flex items-center gap-4">
                    <div class="relative flex-grow">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></div>
                        <input type="search" class="w-full bg-gray-800 border border-gray-700 rounded-full py-3 pl-12 pr-4 text-gray-100 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="搜索 ${DEMO_DATA.recipes.length} 道菜谱...">
                    </div>
                    <button class="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 active:scale-95 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg></button>
                </header>
                <div id="recipes-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
            `;

            const gridEl = pageEl.querySelector('#recipes-grid');
            DEMO_DATA.recipes.forEach((recipe, index) => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 rounded-lg overflow-hidden shadow-lg cursor-pointer hover:ring-2 ring-blue-500 transition-all active:scale-95 fade-in-up';
                card.style.animationDelay = `${index * 75}ms`;
                card.style.opacity = 0;
                card.dataset.recipeId = recipe.id;
                card.innerHTML = `
                    <img src="${recipe.image}" alt="${recipe.name}" class="w-full h-32 object-cover">
                    <div class="p-4">
                        <h3 class="font-bold text-gray-100 truncate">${recipe.name}</h3>
                        <p class="text-xs text-gray-400 mb-2">${recipe.time} 分钟 ・ ${recipe.calories} Kcal</p>
                        <p class="hidden lg:block text-sm text-gray-400 mt-2 h-10 overflow-hidden">${recipe.description}</p>
                        <div class="hidden lg:flex items-center gap-2 mt-3">
                            <span class="text-xs font-semibold px-2 py-1 rounded-full bg-blue-500/20 text-blue-400">${recipe.difficulty}</span>
                            ${recipe.tags.map(tag => `<span class="text-xs font-semibold px-2 py-1 rounded-full bg-gray-700/60 text-gray-300">${tag}</span>`).join('')}
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => {
                    renderRecipeDetailPage(recipe.id);
                    navigateTo('recipe-detail-page');
                });
                gridEl.appendChild(card);
            });
        }

        /**
         * @description Renders the content of the recipe detail page.
         */
        function renderRecipeDetailPage(recipeId) {
            const pageEl = document.getElementById('recipe-detail-page');
            const recipe = DEMO_DATA.recipes.find(r => r.id === recipeId);
            if (!recipe) return;

            pageEl.innerHTML = `
                <button id="back-to-recipes" class="absolute top-6 left-6 z-10 p-2 bg-black bg-opacity-50 rounded-full hover:bg-opacity-75 transition lg:left-28">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <img src="${recipe.image}" alt="菜谱图片" class="w-full h-64 lg:h-80 object-cover">
                <div class="p-4 lg:p-8">
                    <h1 class="text-3xl lg:text-4xl font-bold text-white">${recipe.name}</h1>
                    <p class="text-gray-400 mt-2 lg:max-w-2xl">${recipe.description}</p>
                    
                    <div class="hidden lg:grid grid-cols-5 gap-8 mt-8">
                        <div class="col-span-2">
                            <h2 class="text-xl font-semibold text-white mb-4">食材清单</h2>
                            <ul id="ingredients-list-desktop" class="space-y-3"></ul>
                        </div>
                        <div class="col-span-3">
                            <h2 class="text-xl font-semibold text-white mb-4">烹饪步骤</h2>
                            <ol id="steps-list-desktop" class="space-y-4 list-decimal list-inside text-gray-300"></ol>
                        </div>
                    </div>

                    <div class="lg:hidden mt-6">
                        <div class="border-b border-gray-700">
                            <nav id="recipe-tabs" class="-mb-px flex space-x-6" aria-label="Tabs">
                                <button data-tab="ingredients" class="recipe-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-400">食材清单</button>
                                <button data-tab="steps" class="recipe-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">烹饪步骤</button>
                            </nav>
                        </div>
                        <div id="ingredients-content-mobile" class="tab-content py-4"></div>
                        <div id="steps-content-mobile" class="tab-content hidden py-4"></div>
                    </div>
                </div>
                <div class="sticky bottom-20 lg:bottom-8 p-4 lg:px-8 bg-transparent">
                     <button id="send-to-glasses-btn" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-3 hover:bg-blue-700 active:scale-95 transition shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 11l3-3m0 0l3 3m-3-3v8m0-13a9 9 0 110 18 9 9 0 010-18z" /></svg>
                        <span>发送到眼镜并开始烹饪</span>
                    </button>
                </div>
            `;

            const ingredientsHTML = `<ul class="space-y-3">${recipe.ingredients.map(ing => `<li class="flex items-center"><label class="flex items-center text-gray-300 cursor-pointer"><input type="checkbox" class="form-checkbox h-5 w-5 bg-gray-700 border-gray-600 text-blue-600 rounded focus:ring-blue-500"><span class="ml-3">${ing}</span></label></li>`).join('')}</ul>`;
            const stepsHTML = `<ol class="space-y-4 list-decimal list-inside text-gray-300">${recipe.steps.map(step => `<li>${step}</li>`).join('')}</ol>`;
            
            pageEl.querySelector('#ingredients-list-desktop').innerHTML = ingredientsHTML;
            pageEl.querySelector('#steps-list-desktop').innerHTML = stepsHTML;
            pageEl.querySelector('#ingredients-content-mobile').innerHTML = ingredientsHTML;
            pageEl.querySelector('#steps-content-mobile').innerHTML = stepsHTML;
            
            pageEl.querySelector('#back-to-recipes').addEventListener('click', () => navigateTo('recipes-page'));
            pageEl.querySelector('#send-to-glasses-btn').addEventListener('click', () => {
                toggleModal(overlays.loading, true);
                setTimeout(() => {
                    toggleModal(overlays.loading, false);
                    navigateTo('device-page');
                }, 2000);
            });
            pageEl.querySelectorAll('.recipe-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    pageEl.querySelectorAll('.recipe-tab').forEach(t => { 
                        const isSelected = t === tab;
                        t.classList.toggle('border-blue-500', isSelected); t.classList.toggle('text-blue-400', isSelected);
                        t.classList.toggle('border-transparent', !isSelected); t.classList.toggle('text-gray-400', !isSelected);
                    });
                    pageEl.querySelector('#ingredients-content-mobile').classList.toggle('hidden', tab.dataset.tab !== 'ingredients');
                    pageEl.querySelector('#steps-content-mobile').classList.toggle('hidden', tab.dataset.tab !== 'steps');
                });
            });
        }
        
        /**
         * @description Renders the device information on the Device page.
         */
        function renderDevicePage() {
            const pageEl = document.getElementById('device-page');
            const device = DEMO_DATA.device;
            pageEl.innerHTML = `
                <header><h1 class="text-2xl lg:text-3xl font-bold text-gray-100">我的设备</h1></header>
                <div class="bg-gray-800 rounded-xl shadow-lg p-4 lg:p-6 flex flex-col md:flex-row gap-6">
                    <div class="w-full md:w-1/2 lg:w-2/5 h-64 md:h-96 bg-gray-900 rounded-lg flex items-center justify-center p-4">
                        <canvas id="device-canvas"></canvas>
                    </div>
                    <div class="flex-grow space-y-4 text-gray-300">
                        <h3 class="text-xl font-bold text-white">${device.name}</h3>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full ${device.isConnected ? 'bg-blue-500 animate-pulse' : 'bg-gray-500'}"></span><span class="text-sm">${device.isConnected ? '已连接' : '已断开'}</span></div>
                        <div class="flex items-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg><span>电量: ${device.battery}%</span></div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5 mt-1"><div class="bg-green-500 h-2.5 rounded-full" style="width: ${device.battery}%"></div></div>
                        <button class="w-full mt-4 bg-red-600/80 text-white font-semibold py-3 rounded-lg hover:bg-red-600 transition">断开连接</button>
                    </div>
                </div>
                <div class="space-y-4">
                    <h2 class="text-lg font-semibold text-gray-300 px-2">眼镜端设置</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div id="setting-brightness" class="bg-gray-800 rounded-xl p-4 flex justify-between items-center hover:bg-gray-700/80 cursor-pointer transition">
                            <div><h4 class="font-semibold text-gray-200">显示亮度</h4><p class="text-sm text-gray-400">调整眼镜镜片亮度</p></div>
                            <div class="flex items-center gap-2 text-gray-400"><span id="brightness-value">${device.settings.brightness}%</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></div>
                        </div>
                        <div class="bg-gray-800 rounded-xl p-4 flex justify-between items-center">
                             <div><h4 class="font-semibold text-gray-200">通知管理</h4><p class="text-sm text-gray-400">允许App发送通知</p></div>
                            <label class="switch"><input type="checkbox" ${device.settings.notifications ? 'checked' : ''}><span class="slider"></span></label>
                        </div>
                        <div class="bg-gray-800 rounded-xl p-4 flex justify-between items-center">
                             <div><h4 class="font-semibold text-gray-200">触觉反馈</h4><p class="text-sm text-gray-400">调整操作震动强度</p></div>
                             <span class="font-medium text-gray-300">${device.settings.hapticFeedback}</span>
                        </div>
                         <div class="bg-gray-800 rounded-xl p-4 flex justify-between items-center hover:bg-gray-700/80 cursor-pointer transition">
                             <div><h4 class="font-semibold text-gray-200">显示模式</h4><p class="text-sm text-gray-400">选择不同的显示预设</p></div>
                             <span class="font-medium text-blue-400">${device.settings.displayProfile}</span>
                        </div>
                        <div class="bg-gray-800 rounded-xl p-4 flex justify-between items-center col-span-1 md:col-span-2 hover:bg-gray-700/80 cursor-pointer transition">
                             <div><h4 class="font-semibold text-gray-200">固件更新</h4><p class="text-sm text-gray-400">检查并安装最新固件</p></div>
                            <div class="flex items-center gap-2 text-gray-400"><span id="firmware-version">${device.firmware}</span><button class="text-sm font-semibold text-blue-400 hover:underline">检查更新</button></div>
                        </div>
                    </div>
                </div>
            `;
            
            pageEl.querySelector('#setting-brightness').addEventListener('click', () => {
                const modal = document.getElementById('brightness-modal');
                modal.querySelector('#brightness-slider').value = DEMO_DATA.device.settings.brightness;
                toggleModal(modal, true);
            });
        }

        /**
         * @description Initializes the Three.js scene.
         */
        function initThreeJS() {
            const canvas = document.getElementById('device-canvas');
            if (!canvas || threeScene) return;

            const scene = new THREE.Scene();
            // 加载FBX模型
            const loader = new FBXLoader();
            loader.load('glass.fbx', (object) => {
                // 调整模型大小和位置
                object.scale.set(0.01, 0.01, 0.01);
                object.position.set(0, -0.5, 0);
                scene.add(object);
            }, undefined, (error) => {
                console.error('加载FBX模型时出错:', error);
            });

            const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 2);
            directionalLight.position.set(5, 10, 7.5);
            scene.add(directionalLight);

            const camera = new THREE.PerspectiveCamera(50, canvas.parentElement.clientWidth / canvas.parentElement.clientHeight, 0.1, 1000);
            camera.position.z = 5;

            const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true, antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableZoom = false;
            controls.enablePan = false;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 2.5;

            let animationFrameId;
            function animate() {
                animationFrameId = requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            
            const resizeObserver = new ResizeObserver(() => {
                const parent = canvas.parentElement;
                if (parent.clientWidth === 0) return;
                camera.aspect = parent.clientWidth / parent.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(parent.clientWidth, parent.clientHeight);
            });
            resizeObserver.observe(canvas.parentElement);

            threeScene = {
                destroy: () => {
                    cancelAnimationFrame(animationFrameId);
                    resizeObserver.disconnect();
                    renderer.dispose();
                    threeScene = null;
                }
            };
            animate();
        }

        /**
         * @description Toggles the visibility of a modal with transitions.
         */
        function toggleModal(modalEl, show) {
            if (show) {
                modalEl.classList.remove('modal-hidden');
                void modalEl.offsetWidth; // Trigger reflow
                modalEl.classList.add('modal-visible');
            } else {
                modalEl.classList.remove('modal-visible');
                modalEl.addEventListener('transitionend', () => {
                    modalEl.classList.add('modal-hidden');
                }, { once: true });
            }
        }

        // --- Media Page Functions ---
        
        /**
         * 加载媒体页面
         */
        function renderMediaPage() {
            // 初始化媒体类型切换
            const showPhotosBtn = document.getElementById('show-photos');
            const showVideosBtn = document.getElementById('show-videos');
            const photosSection = document.getElementById('photos-section');
            const videosSection = document.getElementById('videos-section');
            
            showPhotosBtn.addEventListener('click', () => {
                showPhotosBtn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                showPhotosBtn.classList.add('bg-blue-600');
                showVideosBtn.classList.remove('bg-blue-600');
                showVideosBtn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                
                photosSection.classList.remove('hidden');
                videosSection.classList.add('hidden');
                
                loadPhotos();
            });
            
            showVideosBtn.addEventListener('click', () => {
                showVideosBtn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                showVideosBtn.classList.add('bg-blue-600');
                showPhotosBtn.classList.remove('bg-blue-600');
                showPhotosBtn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                
                videosSection.classList.remove('hidden');
                photosSection.classList.add('hidden');
                
                loadVideos();
            });
            
            // 刷新按钮
            document.getElementById('refresh-media').addEventListener('click', () => {
                if (!photosSection.classList.contains('hidden')) {
                    loadPhotos();
                } else {
                    loadVideos();
                }
            });
            
            // 默认加载照片
            loadPhotos();
        }
        
        /**
         * 加载照片
         */
        async function loadPhotos() {
            const photosGrid = document.getElementById('photos-grid');
            const loadingPhotos = document.getElementById('loading-photos');
            const noPhotos = document.getElementById('no-photos');
            
            // 显示加载状态
            loadingPhotos.classList.remove('hidden');
            noPhotos.classList.add('hidden');
            photosGrid.innerHTML = '';
            
            try {
                const response = await fetch('/photos/');
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const links = Array.from(doc.querySelectorAll('a'))
                    .map(link => link.textContent.trim())
                    .filter(filename => filename.match(/\.(jpg|jpeg|png|gif|webp)$/i))
                    .sort((a, b) => b.localeCompare(a)); // 按文件名倒序排列
                
                loadingPhotos.classList.add('hidden');
                
                if (links.length === 0) {
                    noPhotos.classList.remove('hidden');
                    return;
                }
                
                // 创建照片网格
                links.forEach(filename => {
                    const photoEl = document.createElement('div');
                    photoEl.className = 'relative group cursor-pointer overflow-hidden rounded-lg bg-gray-800 aspect-square';
                    photoEl.innerHTML = `
                        <img src="../photos/${filename}" alt="照片" 
                             class="w-full h-full object-cover transition-transform group-hover:scale-110" 
                             loading="lazy"
                             onError="this.src='https://via.placeholder.com/200x200?text=图片加载失败'; console.error('Failed to load image:', '../photos/${filename}');">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white opacity-0 group-hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-2">
                            <p class="text-white text-xs truncate">${filename}</p>
                        </div>
                    `;
                    
                    // 点击查看大图
                    photoEl.addEventListener('click', () => {
                        showPhotoModal(filename);
                    });
                    
                    photosGrid.appendChild(photoEl);
                });
                
            } catch (error) {
                console.error('Error loading photos:', error);
                loadingPhotos.classList.add('hidden');
                noPhotos.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p>加载照片失败</p>
                `;
                noPhotos.classList.remove('hidden');
            }
        }
        
        /**
         * 加载视频
         */
        async function loadVideos() {
            const videosList = document.getElementById('videos-list');
            const loadingVideos = document.getElementById('loading-videos');
            const noVideos = document.getElementById('no-videos');
            
            // 显示加载状态
            loadingVideos.classList.remove('hidden');
            noVideos.classList.add('hidden');
            videosList.innerHTML = '';
            
            try {
                const response = await fetch('/videos/');
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const links = Array.from(doc.querySelectorAll('a'))
                    .map(link => link.textContent.trim())
                    .filter(filename => filename.match(/\.(mp4|avi|mov|webm|mkv)$/i))
                    .sort((a, b) => b.localeCompare(a)); // 按文件名倒序排列
                
                loadingVideos.classList.add('hidden');
                
                if (links.length === 0) {
                    noVideos.classList.remove('hidden');
                    return;
                }
                
                // 创建视频列表
                links.forEach(filename => {
                    const videoEl = document.createElement('div');
                    videoEl.className = 'bg-gray-800 rounded-lg overflow-hidden hover:bg-gray-700 transition-colors';
                    videoEl.innerHTML = `
                        <div class="relative aspect-video bg-gray-900">
                            <video class="w-full h-full object-cover" preload="metadata">
                                <source src="../videos/${filename}" type="video/mp4">
                                您的浏览器不支持视频播放。
                            </video>
                            <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 hover:bg-opacity-30 transition-all cursor-pointer" onclick="playVideo('../videos/${filename}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="p-4">
                            <h3 class="text-white font-medium truncate">${filename}</h3>
                            <p class="text-gray-400 text-sm mt-1">点击播放视频</p>
                        </div>
                    `;
                    
                    videosList.appendChild(videoEl);
                });
                
            } catch (error) {
                console.error('Error loading videos:', error);
                loadingVideos.classList.add('hidden');
                noVideos.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p>加载视频失败</p>
                `;
                noVideos.classList.remove('hidden');
            }
        }
        
        /**
         * 显示照片模态框
         */
        function showPhotoModal(filename) {
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="relative max-w-4xl max-h-full">
                    <img src="../photos/${filename}" alt="照片" class="max-w-full max-h-full object-contain rounded-lg">
                    <button class="absolute top-4 right-4 text-white hover:text-gray-300 transition-colors" onclick="this.closest('.fixed').remove()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <div class="absolute bottom-4 left-4 right-4 text-center">
                        <p class="text-white bg-black bg-opacity-50 rounded px-3 py-1 inline-block">${filename}</p>
                    </div>
                </div>
            `;
            
            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }
        
        /**
         * 播放视频
         */
        function playVideo(videoSrc) {
            // 创建视频播放模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="relative max-w-4xl max-h-full w-full">
                    <video class="w-full h-auto max-h-full rounded-lg" controls autoplay>
                        <source src="${videoSrc}" type="video/mp4">
                        您的浏览器不支持视频播放。
                    </video>
                    <button class="absolute top-4 right-4 text-white hover:text-gray-300 transition-colors" onclick="this.closest('.fixed').remove()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            `;
            
            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }
        
        /**
         * 加载营养建议
         */
        async function loadNutritionAdvice() {
            const loadingAdvice = document.getElementById('loading-advice');
            const nutritionEvaluation = document.getElementById('nutrition-evaluation');
            const dietRecommendation = document.getElementById('diet-recommendation');
            const evaluationContent = document.getElementById('evaluation-content');
            const recommendationContent = document.getElementById('recommendation-content');
            const noAdvice = document.getElementById('no-advice');
            const adviceError = document.getElementById('advice-error');
            
            // 显示加载状态
            loadingAdvice.classList.remove('hidden');
            if (nutritionEvaluation) nutritionEvaluation.classList.add('hidden');
            if (dietRecommendation) dietRecommendation.classList.add('hidden');
            if (noAdvice) noAdvice.classList.add('hidden');
            if (adviceError) adviceError.classList.add('hidden');
            
            try {
                // 直接从服务器获取营养建议JSON文件
                 const response = await fetch('/nutrition_analysis/latest_advice.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                loadingAdvice.classList.add('hidden');
                
                let hasContent = false;
                
                // 显示营养评价
                if (data.evaluation && data.evaluation.trim() && evaluationContent) {
                    evaluationContent.innerHTML = data.evaluation;
                    nutritionEvaluation.classList.remove('hidden');
                    hasContent = true;
                }
                
                // 显示饮食推荐
                if (data.recommendation && data.recommendation.trim() && recommendationContent) {
                    recommendationContent.innerHTML = data.recommendation;
                    dietRecommendation.classList.remove('hidden');
                    hasContent = true;
                }
                
                // 兼容旧格式
                if (!hasContent && data.advice && data.advice.trim()) {
                    if (evaluationContent) {
                        evaluationContent.innerHTML = data.advice;
                        nutritionEvaluation.classList.remove('hidden');
                        hasContent = true;
                    }
                }
                
                // 如果都没有内容，显示无建议状态
                if (!hasContent && noAdvice) {
                    noAdvice.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('加载营养建议失败:', error);
                loadingAdvice.classList.add('hidden');
                
                // 显示错误状态
                if (adviceError) {
                    adviceError.classList.remove('hidden');
                } else if (noAdvice) {
                    noAdvice.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm">加载营养建议失败</p>
                        <p class="text-xs text-gray-600 mt-1">请稍后重试</p>
                    `;
                    noAdvice.classList.remove('hidden');
                }
            }
        }

        // --- Initial Application Setup ---
        function initApp() {
            // Initialize chat page
            document.getElementById('refresh-chats').addEventListener('click', loadChatHistory);
            document.getElementById('clear-chats').addEventListener('click', clearChatHistory);

            // Initialize meeting page
            document.getElementById('refresh-meetings').addEventListener('click', loadMeetingRecords);
            document.getElementById('clear-meetings').addEventListener('click', clearMeetingRecords);

            // Load chat history when chat page is navigated to
            // Load meeting records when meeting page is navigated to
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.page === 'chat-page') {
                        loadChatHistory();
                    } else if (btn.dataset.page === 'meeting-page') {
                        loadMeetingRecords();
                    }
                });
            });
            // Initial page renders
            renderHomePage();
            renderRecipesPage();
            renderDevicePage();
            renderMeetingPage();
            renderMediaPage();
            
            // Load food data
            loadFoodRecords();
            
            // Setup navigation
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => navigateTo(btn.dataset.page));
            });

            // Setup brightness modal listeners
            const brightnessModal = document.getElementById('brightness-modal');
            brightnessModal.querySelector('#close-modal-btn').addEventListener('click', () => toggleModal(brightnessModal, false));
            brightnessModal.querySelector('#brightness-slider').addEventListener('input', (e) => {
                const value = e.target.value;
                DEMO_DATA.device.settings.brightness = value;
                const brightnessValueEl = document.getElementById('brightness-value');
                if(brightnessValueEl) brightnessValueEl.textContent = `${value}%`;
            });

            // Set initial page
            navigateTo('home-page');
        }

        document.addEventListener('DOMContentLoaded', initApp);

    </script>

</body>
</html>